<!--
  Copyright 2014 Atsushi Kojo.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="force-bulk in">
  <div class="form-row">
    <label for="node-input-force"><i class="fa fa-user"></i> Log in as</label>
    <input type="text" id="node-input-force">
  </div>
  <div class="form-row">
    <label for="node-input-operation"><i class="fa fa-wrench"></i> Operation</label>
    <select type="text" id="node-input-operation">
      <option value="query">query</option>
      <option value="insert_record">insert(Record)</option>
      <option value="insert_csv">insert(CSV)</option>
      <option value="update">update</option>
      <option value="upsert">upsert</option>
      <option value="delete">delete</option>
<!--      <option value="hardDelete">hardDelete</option>-->
    </select>
  </div>
  <div class="form-row input-sobject-row">
    <label for="node-input-sobject"><i class="fa fa-table"></i> Sobject</label>
    <input type="text" id="node-input-sobject" placeholder="Sobject">
  </div>
  <div class="form-row input-extname-row hidden">
    <label for="node-input-extname"><i class="fa fa-table"></i> External ID field name</label>
    <input type="text" id="node-input-extname" placeholder="External ID field name">
  </div>
  <div class="form-row input-polltimeout-row">
    <label for="node-input-polltimeout"><i class="fa fa-tag"></i> API Polling Timeout</label>
    <input type="text" id="node-input-polltimeout" placeholder="10000">
  </div>
  <div class="form-row input-localfilename-row hidden">
    <label for="node-input-localfilename"><i class="fa fa-file"></i> Local Filename</label>
    <input type="text" id="node-input-localfilename" placeholder="Local Filename">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>

<script type="text/x-red" data-help-name="force-bulk in">
    <p>force.com bulk処理ノード。<code>Operation</code>で選択した以下の処理を実行します。</p>
    <ul>
      <li>検索</li>
      <li>作成(レコード単位)</li>
      <li>作成(CSV一括)</li>
      <li>更新</li>
      <li>作成/更新</li>
      <li>削除</li>
    </ul>

    <h3>入力</h3>
      <dl class="message-properties">
        <dt class="optional">payload
          <span class="property-type">文字列 | 配列</span>
        </dt>
        <dd> 選択した処理を実行するデータを入力します。 </dd>
      </dl>

    <h3>出力</h3>
      <dl class="message-properties">
        <dt>payload <span class="property-type">配列 | オブジェクト</span></dt>
        <dd>選択した処理の実行結果を出力します。</dd>
      </dl>

    <h3>詳細</h3>
    <h4>検索</h4>
      <p> <code>msg.payload</code>で受け取ったSOQLクエリにて検索を実行します。受信可能なプロパティタイプは<code>文字列</code>です。 </p>
      <p> <code>msg.payload = "select Id, Name from Account";</code> </p>
      <p> <code>Sobject</code>にデータを検索するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>Local Filename</code>に出力するCSVファイル名を指定します。ファイル名は相対パス、絶対パスどちらでも可能です。</p>
      <p>取得した検索結果のCSVファイルを作成し、指定されたファイルへ出力します。また、ファイルを出力した旨のメッセージを<code>msg.payload</code>に格納して出力します。</p>

    <h4>作成(レコード単位): </h4>
      <p> <code>msg.payload</code>で受け取ったjsonオブジェクトデータをもとに設定したオブジェクトにデータを新規作成します。受信可能なプロパティタイプは<code>配列</code>です。 </p>
      <p> <code>msg.payload = [{Name: 'hoge'},{Name: 'fuga'}];</code> </p>
      <p> <code>Sobject</code>にデータを作成するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>API Polling Timeout</code>にポーリングタイムアウトをミリ秒で設定します。</p>
      <p>作成の実行結果は<code>msg.payload</code>にjsonオブジェクトにて格納して出力します。</p>

    <h4>作成(CSV単位): </h4>
      <p> <code>Local Filename</code>に設定されたファイルを読み込み、設定したオブジェクトにデータを新規作成します。</p>
      <p> <code>Sobject</code>にデータを作成するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>API Polling Timeout</code>にポーリングタイムアウトをミリ秒で設定します。</p>
      <p> <code>Local Filename</code>に作成するデータのCSVファイル名を指定します。ファイル名は相対パス、絶対パスどちらでも可能です。</p>
      <p>作成の実行結果は<code>msg.payload</code>にjsonオブジェクトにて格納して出力します。</p>

    <h4>更新: </h4>
      <p> <code>Local Filename</code>に設定されたファイルを読み込み、設定したオブジェクトのデータを更新します。</p>
      <p> <code>Sobject</code>にデータを更新するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>API Polling Timeout</code>にポーリングタイムアウトをミリ秒で設定します。</p>
      <p> <code>Local Filename</code>に更新するデータのCSVファイル名を指定します。ファイル名は相対パス、絶対パスどちらでも可能です。</p>
      <p>更新の実行結果は<code>msg.payload</code>にjsonオブジェクトにて格納して出力します。</p>

    <h4>作成/更新: </h4>
      <p> <code>Local Filename</code>に設定されたファイルを読み込み、設定したオブジェクトのデータを新規作成または更新します。</p>
      <p> <code>Sobject</code>にデータを作成または更新するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>External ID field name</code>にデータの作成または更新を判定するキーとなる外部ID項目の項目名(API参照名)を設定します。</p>
      <p> <code>API Polling Timeout</code>にポーリングタイムアウトをミリ秒で設定します。</p>
      <p> <code>Local Filename</code>に作成または更新するデータのCSVファイル名を指定します。ファイル名は相対パス、絶対パスどちらでも可能です。</p>
      <p>作成/更新の実行結果は<code>msg.payload</code>にjsonオブジェクトにて格納して出力します。</p>

    <h4>削除: </h4>
      <p> <code>Local Filename</code>に設定されたファイルを読み込み、設定したオブジェクトのデータを削除します。</p>
      <p> <code>Sobject</code>にデータを削除するオブジェクトのオブジェクト名(API参照名)を設定します。</p>
      <p> <code>API Polling Timeout</code>にポーリングタイムアウトをミリ秒で設定します。</p>
      <p> <code>Local Filename</code>に作成または更新するデータのCSVファイル名を指定します。ファイル名は相対パス、絶対パスどちらでも可能です。</p>
      <p>削除の実行結果は<code>msg.payload</code>にjsonオブジェクトにて格納して出力します。</p>

</script>

<script type="text/javascript">
  RED.nodes.registerType('force-bulk in', {
    category: 'storage-input',
    color: "#48ace4",
    defaults: {
      force: { type: 'force', required: true },
      operation: { value: 'query' },
      sobject: { value: '' },
      extname: { value: '' },
      polltimeout: { value: 10000 },
      localfilename: { value: '' },
      name: { value: '' }
    },
    inputs: 1,
    outputs: 1,
    icon: 'force.png',
    label: function () {
      var forceNode = RED.nodes.node(this.force);
      return this.name || 'force-bulk';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    oneditprepare: function () {
      var inNode = RED.nodes.node(this.id);
      var sobjel = $(".input-sobject-row");
      var extel = $(".input-extname-row");
      var toutl = $(".input-polltimeout-row");
      var filel = $(".input-localfilename-row");
      $("#node-input-operation").change(function () {
        var id = $("#node-input-operation option:selected").val();
        if(id != inNode.operation){
          $("#node-input-localfilename").val("");
          $("#node-input-extname").val("");
        }
        if (id == 'query') {
          sobjel.show();
          extel.hide();
          toutl.hide();
          filel.show();
        } else if(id == 'insert_record') {
          sobjel.show();
          extel.hide();
          toutl.show();
          filel.hide();
        } else if(id == 'upsert') {
          sobjel.show();
          extel.show();
          toutl.show();
          filel.show();
        } else {
          sobjel.show();
          extel.hide();
          toutl.show();
          filel.show();
        }
      });
    }
  });
</script>
